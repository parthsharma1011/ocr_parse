name: Deploy

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp *.py requirements.txt .env.example README.md deployment/
        echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > deployment/build_info.txt
        echo "COMMIT_SHA=${{ github.sha }}" >> deployment/build_info.txt
        echo "BRANCH=${{ github.ref_name }}" >> deployment/build_info.txt
        echo "VERSION=v2.0.0" >> deployment/build_info.txt
    
    - name: Create release archive
      run: |
        cd deployment
        tar -czf ../ocr-app-${{ github.sha }}.tar.gz .
        cd ..
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package-${{ github.sha }}
        path: ocr-app-${{ github.sha }}.tar.gz
        retention-days: 90
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ocr-app-${{ github.sha }}.tar.gz
        body: |
          ## ðŸš€ PDF OCR Processing Tool Release
          
          ### Installation
          1. Download and extract the release package
          2. Copy `.env.example` to `.env` and add your API key
          3. Install dependencies: `pip install -r requirements.txt`
          4. Run: `python call.py`
          
          Built from commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}